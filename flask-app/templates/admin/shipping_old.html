{% extends "base.html" %}

{% block page_title %}Shipping Dashboard{% endblock %}
{% block page_description %}Track orders and shipments from all providers{% endblock %}

{% block header_actions %}
<a href="{{ url_for('admin_accounts') }}" class="btn bg-gray-500 text-white hover:bg-gray-600">
    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
    </svg>
    Manage Accounts
</a>
{% endblock %}

{% block extra_head %}
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=geometry" async defer></script>
<style>
    .tracking-map {
        height: 300px;
        width: 100%;
        border-radius: 0.5rem;
    }
    .status-badge {
        @apply inline-flex px-2 py-1 text-xs font-semibold rounded-full;
    }
    .status-ordered { @apply bg-blue-100 text-blue-800; }
    .status-shipped { @apply bg-yellow-100 text-yellow-800; }
    .status-in_transit { @apply bg-purple-100 text-purple-800; }
    .status-delivered { @apply bg-green-100 text-green-800; }
    .status-delayed { @apply bg-red-100 text-red-800; }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card p-4">
            <div class="flex items-center">
                <div class="p-2 bg-blue-100 rounded-lg">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <div class="text-2xl font-bold text-gray-900">{{ shipping_orders|selectattr('status', 'equalto', 'ordered')|list|length }}</div>
                    <div class="text-sm text-gray-600">Ordered</div>
                </div>
            </div>
        </div>
        
        <div class="card p-4">
            <div class="flex items-center">
                <div class="p-2 bg-yellow-100 rounded-lg">
                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <div class="text-2xl font-bold text-gray-900">{{ shipping_orders|selectattr('status', 'equalto', 'shipped')|list|length }}</div>
                    <div class="text-sm text-gray-600">Shipped</div>
                </div>
            </div>
        </div>
        
        <div class="card p-4">
            <div class="flex items-center">
                <div class="p-2 bg-purple-100 rounded-lg">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <div class="text-2xl font-bold text-gray-900">{{ shipping_orders|selectattr('status', 'equalto', 'in_transit')|list|length }}</div>
                    <div class="text-sm text-gray-600">In Transit</div>
                </div>
            </div>
        </div>
        
        <div class="card p-4">
            <div class="flex items-center">
                <div class="p-2 bg-green-100 rounded-lg">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <div class="text-2xl font-bold text-gray-900">{{ shipping_orders|selectattr('status', 'equalto', 'delivered')|list|length }}</div>
                    <div class="text-sm text-gray-600">Delivered</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card p-4">
        <div class="flex flex-wrap gap-4 items-center">
            <div>
                <label for="provider-filter" class="block text-sm font-medium text-gray-700 mb-1">Provider</label>
                <select id="provider-filter" class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-bluez-500">
                    <option value="">All Providers</option>
                    {% for account in accounts %}
                    <option value="{{ account.provider }}">{{ account.provider|replace('_', ' ')|title }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="status-filter" class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-bluez-500">
                    <option value="">All Statuses</option>
                    <option value="ordered">Ordered</option>
                    <option value="shipped">Shipped</option>
                    <option value="in_transit">In Transit</option>
                    <option value="delivered">Delivered</option>
                    <option value="delayed">Delayed</option>
                </select>
            </div>
            
            <div>
                <label for="date-filter" class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                <select id="date-filter" class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-bluez-500">
                    <option value="">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                </select>
            </div>
            
            <div class="ml-auto">
                <button onclick="refreshData()" class="btn btn-primary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Orders List -->
    <div class="card">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Shipping Orders</h2>
            <p class="text-sm text-gray-600">Track all your orders from connected providers</p>
        </div>
        
        {% if shipping_orders %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Provider</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tracking</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estimated Delivery</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for order in shipping_orders %}
                    <tr class="hover:bg-gray-50 order-row" data-provider="{{ order.account.provider }}" data-status="{{ order.status }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ order.order_id }}</div>
                            {% if order.order_number %}
                            <div class="text-sm text-gray-500">Internal: {{ order.order_number }}</div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                {% if order.account.provider == 'fcpeuro' %}
                                <div class="h-6 w-6 bg-red-500 rounded-full flex items-center justify-center text-white font-bold text-xs mr-2">FC</div>
                                {% elif order.account.provider == 'orielly' %}
                                <div class="h-6 w-6 bg-yellow-500 rounded-full flex items-center justify-center text-white font-bold text-xs mr-2">OR</div>
                                {% elif order.account.provider == 'autozone' %}
                                <div class="h-6 w-6 bg-red-600 rounded-full flex items-center justify-center text-white font-bold text-xs mr-2">AZ</div>
                                {% elif order.account.provider == 'harborfreight' %}
                                <div class="h-6 w-6 bg-orange-500 rounded-full flex items-center justify-center text-white font-bold text-xs mr-2">HF</div>
                                {% elif order.account.provider == 'amazon' %}
                                <div class="h-6 w-6 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xs mr-2">AM</div>
                                {% endif %}
                                <span class="text-sm text-gray-900">{{ order.account.account_name }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-badge status-{{ order.status }}">
                                {{ order.status|replace('_', ' ')|title }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if order.tracking_number %}
                            <div class="text-sm text-gray-900">{{ order.tracking_number }}</div>
                            <div class="text-sm text-gray-500">{{ order.carrier or 'Unknown Carrier' }}</div>
                            {% else %}
                            <span class="text-sm text-gray-400">No tracking</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if order.estimated_delivery %}
                            <div class="text-sm text-gray-900">{{ order.estimated_delivery.strftime('%Y-%m-%d') }}</div>
                            <div class="text-sm text-gray-500">{{ order.estimated_delivery.strftime('%H:%M') }}</div>
                            {% else %}
                            <span class="text-sm text-gray-400">TBD</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="showTrackingDetails({{ order.id }})" class="text-bluez-600 hover:text-bluez-900 mr-3">
                                Track
                            </button>
                            {% if order.tracking_number %}
                            <button onclick="showMap({{ order.id }})" class="text-green-600 hover:text-green-900">
                                Map
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-8 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No shipping orders</h3>
            <p class="mt-1 text-sm text-gray-500">Orders will appear here once your accounts sync data.</p>
            <div class="mt-6">
                <a href="{{ url_for('admin_accounts') }}" class="btn btn-primary">
                    Configure Accounts
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Tracking Details Modal -->
<div id="tracking-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Tracking Details</h3>
                <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="tracking-content" class="p-6">
                <!-- Tracking content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Map Modal -->
<div id="map-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Shipment Tracking Map</h3>
                <button onclick="closeMapModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <div id="tracking-map" class="tracking-map"></div>
            </div>
        </div>
    </div>
</div>

<script>
let map;
let trackingMarkers = [];

// Filter functionality
document.getElementById('provider-filter').addEventListener('change', filterOrders);
document.getElementById('status-filter').addEventListener('change', filterOrders);
document.getElementById('date-filter').addEventListener('change', filterOrders);

function filterOrders() {
    const providerFilter = document.getElementById('provider-filter').value;
    const statusFilter = document.getElementById('status-filter').value;
    const dateFilter = document.getElementById('date-filter').value;
    
    const rows = document.querySelectorAll('.order-row');
    
    rows.forEach(row => {
        let show = true;
        
        if (providerFilter && row.dataset.provider !== providerFilter) {
            show = false;
        }
        
        if (statusFilter && row.dataset.status !== statusFilter) {
            show = false;
        }
        
        // Date filtering would require additional data attributes
        // Implementation depends on specific requirements
        
        row.style.display = show ? '' : 'none';
    });
}

function refreshData() {
    // Implement refresh functionality
    location.reload();
}

function showTrackingDetails(orderId) {
    fetch(`/api/shipping/orders/${orderId}/tracking`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error loading tracking data: ' + data.error);
                return;
            }
            
            let content = `
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold">Order Information</h4>
                        <p><strong>Order ID:</strong> ${data.order.order_id}</p>
                        <p><strong>Tracking Number:</strong> ${data.order.tracking_number || 'N/A'}</p>
                        <p><strong>Status:</strong> ${data.order.status}</p>
                        <p><strong>Estimated Delivery:</strong> ${data.order.estimated_delivery || 'TBD'}</p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold mb-3">Tracking Events</h4>
                        <div class="space-y-3">
            `;
            
            if (data.tracking_events && data.tracking_events.length > 0) {
                data.tracking_events.forEach(event => {
                    content += `
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <div class="w-3 h-3 bg-bluez-500 rounded-full mt-1"></div>
                            <div class="flex-1">
                                <div class="font-medium">${event.status}</div>
                                <div class="text-sm text-gray-600">${event.description || ''}</div>
                                <div class="text-xs text-gray-500">${event.location || ''} - ${new Date(event.date).toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                });
            } else {
                content += '<p class="text-gray-500">No tracking events available</p>';
            }
            
            content += `
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('tracking-content').innerHTML = content;
            document.getElementById('tracking-modal').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading tracking data');
        });
}

function showMap(orderId) {
    fetch(`/api/shipping/orders/${orderId}/tracking`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error loading tracking data: ' + data.error);
                return;
            }
            
            document.getElementById('map-modal').classList.remove('hidden');
            
            // Initialize map
            if (!map) {
                map = new google.maps.Map(document.getElementById('tracking-map'), {
                    zoom: 4,
                    center: { lat: 39.8283, lng: -98.5795 } // Center of USA
                });
            }
            
            // Clear existing markers
            trackingMarkers.forEach(marker => marker.setMap(null));
            trackingMarkers = [];
            
            // Add markers for tracking events with coordinates
            if (data.tracking_events) {
                const bounds = new google.maps.LatLngBounds();
                
                data.tracking_events.forEach((event, index) => {
                    if (event.latitude && event.longitude) {
                        const marker = new google.maps.Marker({
                            position: { lat: event.latitude, lng: event.longitude },
                            map: map,
                            title: event.status,
                            label: String(index + 1)
                        });
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: `
                                <div>
                                    <h4>${event.status}</h4>
                                    <p>${event.description || ''}</p>
                                    <p><strong>Location:</strong> ${event.location}</p>
                                    <p><strong>Date:</strong> ${new Date(event.date).toLocaleString()}</p>
                                </div>
                            `
                        });
                        
                        marker.addListener('click', () => {
                            infoWindow.open(map, marker);
                        });
                        
                        trackingMarkers.push(marker);
                        bounds.extend(marker.getPosition());
                    }
                });
                
                if (trackingMarkers.length > 0) {
                    map.fitBounds(bounds);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading map data');
        });
}

function closeModal() {
    document.getElementById('tracking-modal').classList.add('hidden');
}

function closeMapModal() {
    document.getElementById('map-modal').classList.add('hidden');
}

// Close modals when clicking outside
document.getElementById('tracking-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

document.getElementById('map-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeMapModal();
    }
});
</script>
{% endblock %}
